<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daily English+ ‚Äî Premium iOS Style</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* ---------------- Theme / Reset ---------------- */
    :root{
        /* Default Light Theme - Violet Accent */
        --theme-mode: light;
        --bg-grad: linear-gradient(135deg,#eef6ff 0%, #f8f9ff 45%, #fff 100%);
        --glass-bg: rgba(255,255,255,0.55);
        --glass-border: rgba(255,255,255,0.6);
        --text-color: #0f172a; /* Main text color */
        --accent: #6c5ce7; /* Violet */
        --accent-2: #00c2b8; /* Cyan for contrast/charts */
        --accent-grad: linear-gradient(90deg,var(--accent), #8a7bff);
        --muted: #6b7280;
        --card-radius: 20px;
        --shadow: 0 10px 30px rgba(17,24,39,0.08);
        --glass-shadow: 0 6px 20px rgba(108,92,231,0.08);
        --glass-border-2: rgba(255,255,255,0.25);
        --input-bg: rgba(255,255,255,0.85); /* Background for inputs, selects, small cards */
    }
    
    /* Dark Mode Overrides */
    .dark-mode{
        --theme-mode: dark;
        --bg-grad: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        --glass-bg: rgba(31, 41, 55, 0.65);
        --glass-border: rgba(255,255,255,0.05);
        --text-color: #f3f4f6;
        --muted: #9ca3af;
        --shadow: 0 10px 30px rgba(0,0,0,0.5);
        --glass-shadow: 0 6px 20px rgba(108,92,231,0.05);
        --glass-border-2: rgba(255,255,255,0.08);
        --input-bg: rgba(31, 41, 55, 0.95);
    }
    /* Apply dark mode text/background/border to specific elements */
    .dark-mode .panel, .dark-mode .chart-card { border-color: var(--glass-border); }
    .dark-mode input, .dark-mode .select, .dark-mode .chip, .dark-mode .fav-item, .dark-mode .word-main, .dark-mode .small-card, .dark-mode .log { 
        background: var(--input-bg); 
        border-color: rgba(255,255,255,0.1); 
        color: var(--text-color); 
    }
    .dark-mode .word-main {
        background: linear-gradient(180deg, rgba(31, 41, 55, 0.9), rgba(31, 41, 55, 0.8));
    }
    .dark-mode .word-info p.def, .dark-mode .example { color: var(--text-color); }
    .dark-mode .icon-btn { border-color: rgba(255,255,255,0.1); color: var(--text-color); }
    .dark-mode .icon-btn:hover { background: rgba(255,255,255,0.05); }


    
    /* Accent Themes */
    .theme-blue { --accent: #3b82f6; --accent-grad: linear-gradient(90deg,#3b82f6, #60a5fa); }
    .theme-green { --accent: #10b981; --accent-grad: linear-gradient(90deg,#10b981, #34d399); }
    .theme-violet { --accent: #6c5ce7; --accent-grad: linear-gradient(90deg,#6c5ce7, #8a7bff); }


    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;color:var(--text-color);background:var(--bg-grad);-webkit-font-smoothing:antialiased;transition:background-color 0.3s}
    
    /* Background illustration subtle */
    body::before{
        content:"";
        position:fixed;inset:0;
        /* Change opacity based on theme mode */
        opacity: var(--theme-mode, 1); 
        background-image: radial-gradient(circle at 10% 10%, rgba(108,92,231,0.06) 0 200px, transparent 201px),
                          radial-gradient(circle at 90% 80%, rgba(0,194,184,0.04) 0 240px, transparent 241px);
        pointer-events:none;
        z-index:0;
    }

    /* --------------- Layout --------------- */
    .wrap{max-width:1250px;margin:28px auto;padding:18px;position:relative;z-index:1}
    
    /* Responsive Header */
    header.app-header{
        display:flex;align-items:center;gap:16px;
        background: linear-gradient(90deg, rgba(255,255,255,0.22), rgba(255,255,255,0.12));
        border-radius: 18px;
        padding:18px 20px;
        box-shadow:var(--glass-shadow);
        backdrop-filter: blur(8px) saturate(120%);
        border:1px solid var(--glass-border-2);
        margin-bottom:18px;
        transition: background-color 0.3s, border-color 0.3s;
    }
    .dark-mode header.app-header {
        background: linear-gradient(90deg, rgba(31, 41, 55, 0.22), rgba(31, 41, 55, 0.12));
    }
    header.app-header .logo{
        width:58px;height:58px;border-radius:14px;
        display:flex;align-items:center;justify-content:center;
        background: var(--accent-grad);
        color:white;font-size:22px;box-shadow: 0 6px 18px rgba(108,92,231,0.18);
    }
    header.app-header .meta h1{margin:0;font-size:1.45rem;letter-spacing:0.2px}
    header.app-header .meta p{margin:3px 0 0;color:var(--muted);font-size:0.95rem}

    /* Grid */
    .grid{
        display:grid;
        grid-template-columns: 1fr 380px;
        gap:18px;
    }
    
    /* Left column - learning area */
    .panel{
        background:var(--glass-bg);
        border-radius:var(--card-radius);
        padding:18px;
        box-shadow:var(--shadow);
        border:1px solid var(--glass-border);
        backdrop-filter: blur(10px);
        transition: background-color 0.3s, border-color 0.3s;
    }

    .top-controls{display:flex;gap:12px;align-items:center;margin-bottom:12px; flex-wrap: wrap;}
    .select, .btn{
        border-radius:999px;padding:10px 14px;border:none;font-weight:600;cursor:pointer;
        transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    .select{background:var(--input-bg);border:1px solid rgba(15,23,42,0.06);color:var(--text-color)}
    .btn.primary{background:var(--accent-grad);color:white;box-shadow:0 8px 20px rgba(108,92,231,0.12)}
    .btn.ghost{background:transparent;border:1px solid rgba(15,23,42,0.06);color:var(--muted)}

    /* Word Card big */
    .word-main{
        display:grid;grid-template-columns: 120px 1fr;gap:14px;align-items:center;
        padding:16px;border-radius:14px;
        background:linear-gradient(180deg, var(--input-bg), rgba(255,255,255,0.55));
        border:1px solid var(--glass-border-2);margin-bottom:14px;
        transition: background-color 0.3s, border-color 0.3s;
    }
    .word-img{width:120px;height:120px;border-radius:12px;overflow:hidden;flex-shrink:0;background:#eee}
    .word-img img{width:100%;height:100%;object-fit:cover;display:block}
    .word-info h2{margin:0;font-size:1.6rem;color:var(--accent)}
    .word-info .meta{color:var(--muted);margin-top:6px;font-size:0.95rem}
    .word-info p.def{margin:10px 0 0;color:var(--text-color);opacity:0.9}
    .tags{display:flex;gap:8px;margin-top:10px; flex-wrap: wrap;}

    .chip{
        background:var(--input-bg);padding:8px 12px;border-radius:999px;border:1px solid rgba(15,23,42,0.04);
        font-weight:600;color:var(--muted);font-size:0.9rem;
        transition: background-color 0.3s, border-color 0.3s;
    }

    /* Pronunciation & audio */
    .audio-controls{display:flex;gap:8px;margin-top:12px;align-items:center; flex-wrap: wrap;}
    .icon-btn{background:transparent;border:1px solid rgba(15,23,42,0.06);padding:10px;border-radius:12px;cursor:pointer}

    /* Example sentence box */
    .example{
        margin-top:12px;padding:12px;border-radius:12px;background:linear-gradient(90deg, rgba(0,194,184,0.04), rgba(108,92,231,0.02));
        font-style:italic;color:var(--text-color);
        transition: background-color 0.3s, color 0.3s;
    }
    .dark-mode .example { background: rgba(0,194,184,0.05); }

    /* Mini quiz & favourites */
    .mini-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}

    .small-card{
        padding:12px;border-radius:12px;background:var(--input-bg);border:1px solid rgba(15,23,42,0.04);
        transition: background-color 0.3s, border-color 0.3s;
    }
    .small-card h4{margin:0 0 8px 0;color:var(--accent)}
    .small-card input {
        color: var(--text-color); /* Fix input text color in dark mode */
        background: var(--input-bg); /* Fix input background in dark mode */
    }

    /* Right column - stats / history */
    .side{
        display:flex;flex-direction:column;gap:12px;
    }
    .chart-card{
        padding:12px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.8));border:1px solid rgba(15,23,42,0.04);
        transition: background-color 0.3s, border-color 0.3s;
    }
    .dark-mode .chart-card { background: var(--glass-bg); }

    .stat-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed rgba(15,23,42,0.03)}
    .stat-row:last-child{border-bottom:none}
    .muted{color:var(--muted);font-size:0.92rem}

    /* Favorites list */
    .fav-list{display:flex;flex-direction:column;gap:8px;max-height:260px;overflow:auto;padding-right:6px}
    .fav-item{
        display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;background:var(--input-bg);border:1px solid rgba(15,23,42,0.04);
        transition: background-color 0.3s, border-color 0.3s;
    }
    .fav-item .fav-word{font-weight:700;color:var(--accent);}
    .fav-item .fav-trans{color:var(--muted);font-size:0.9rem}

    /* logs */
    .log{
        font-size:0.85rem;color:var(--muted);max-height:160px;overflow:auto;padding:8px;border-radius:10px;background:var(--input-bg);border:1px solid rgba(15,23,42,0.03);
        transition: background-color 0.3s, border-color 0.3s;
    }
    /* animations */
    .fade-up{animation:fadeUp .5s cubic-bezier(.2,.9,.3,1)}
    @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

    footer{margin-top:28px;padding:20px 0;text-align:center;color:var(--muted);font-size:0.9rem;border-top:1px solid rgba(15,23,42,0.04)}
    
    /* Flags styles (kept from previous version) */
    .flag {
        display: inline-block;
        width: 20px;
        height: 14px;
        margin: 0 4px;
        border: 1px solid rgba(0,0,0,0.1);
        vertical-align: middle;
        background-size: cover;
        background-position: center;
        border-radius: 2px;
    }
    .flag.palestine { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 6 3"><rect width="6" height="3" fill="#000"/><rect width="6" height="2" fill="#fff" y="1"/><rect width="6" height="1" fill="#000" y="2"/><path fill="#e30000" d="M0 0l3 1.5L0 3z"/></svg>'); }
    .flag.ukraine { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 12"><rect width="18" height="6" fill="#0057b7"/><rect width="18" height="6" fill="#ffd700" y="6"/></svg>'); }


    /* Settings Panel (kept from previous version) */
    #settings-btn {
        position: fixed;
        bottom: 25px;
        right: 25px;
        z-index: 1000;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--accent-grad);
        color: white;
        border: none;
        box-shadow: 0 4px 15px var(--accent);
        cursor: pointer;
        font-size: 1.2rem;
        transition: transform 0.3s;
    }
    #settings-btn:hover { transform: scale(1.05); }

    #settings-panel {
        position: fixed;
        bottom: 80px;
        right: 20px;
        z-index: 999;
        width: 280px;
        padding: 15px;
        border-radius: 14px;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        box-shadow: var(--shadow);
        backdrop-filter: blur(8px);
        transform: translateY(10px) scale(0.95);
        opacity: 0;
        pointer-events: none;
        transition: all 0.3s;
    }
    #settings-panel.open {
        transform: translateY(0) scale(1);
        opacity: 1;
        pointer-events: auto;
    }
    #settings-panel h4 { margin: 0 0 10px 0; color: var(--accent); }
    .setting-group { margin-bottom: 15px; }
    .setting-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-color); }
    
    .theme-select button {
        width: 32%;
        padding: 10px;
        border-radius: 8px;
        border: 2px solid transparent;
        cursor: pointer;
        font-weight: 600;
        background: var(--input-bg);
        transition: border-color 0.2s;
    }
    .theme-select button.active { border-color: var(--accent); }

    .color-select { display: flex; gap: 8px; }
    .color-select button {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        border: 2px solid transparent;
        cursor: pointer;
        transition: border-color 0.2s;
    }
    .color-select button.active { border-color: var(--text-color); }
    .color-select .violet { background-color: #6c5ce7; }
    .color-select .green { background-color: #10b981; }
    .color-select .blue { background-color: #3b82f6; }

    /* Responsive adjustments */
    @media (max-width:1050px){ 
        .grid{grid-template-columns:1fr} 
    }
    @media (max-width:768px){
        /* Header adjustments for smaller screens */
        header.app-header { 
            flex-wrap: wrap; 
            padding: 12px 15px;
        }
        header.app-header .logo{
             width: 48px; height: 48px; font-size: 18px;
        }
        header.app-header .meta h1 { 
            font-size: 1.2rem; /* Make title smaller */
        }
        .header-title-full { display: none; } /* Hide full title */
        .header-title-mobile { display: block; } /* Show mobile title */
        .header-greeting { display: none !important; } /* Hide greeting on mobile */
        
        /* Main card adjustments */
        .word-main { 
            grid-template-columns: 80px 1fr; /* Image smaller and align to info */
            gap: 10px;
            padding: 12px;
        }
        .word-img { width: 80px; height: 80px; }
        .word-info h2 { font-size: 1.4rem; }
        .word-info .meta, .word-info p.def { font-size: 0.9rem; }

        /* Grid card list adjustment */
        .mini-grid{grid-template-columns:1fr} 
        
        /* Controls adjustments */
        .top-controls { justify-content: space-between; }
        .top-controls > div:last-child { display: none; } /* Hide date on mobile */
    }
    /* Only show mobile title on small screens */
    .header-title-mobile { display: none; } 
</style>
</head>
<body id="app-body">
<div class="wrap">
    <header class="app-header">
        <div class="logo"><i class="fas fa-atom"></i></div>
        <div class="meta">
            <h1 id="app-title-display">
                <span class="header-title-full">Daily English+ ‚Äî Premium</span>
                <span class="header-title-mobile">Daily English+</span>
            </h1>
            <p id="app-subtitle">Style iOS ‚Ä¢ glass ‚Ä¢ rounded ‚Ä¢ images motivantes ‚Ä¢ voix int√©gr√©e</p>
        </div>
    </header>

    <div class="grid">
        <div>
            <div class="panel fade-up">
                <div class="top-controls">
                    <select id="wordsPerDay" class="select" title="Nombre de mots par jour">
                        <option value="3">3 mots / jour</option>
                        <option value="5" selected>5 mots / jour</option>
                        <option value="8">8 mots / jour</option>
                    </select>
                    <button id="startBtn" class="btn primary"><i class="fas fa-play"></i>&nbsp;D√©marrer</button>
                    <button id="nextBtn" class="btn ghost"><i class="fas fa-random"></i>&nbsp;Nouveaux</button>
                    <div style="flex:1"></div>
                    <div class="muted">Mode iOS ‚Ä¢ <strong id="todayDate"></strong></div>
                </div>

                <div id="wordArea" class="word-main">
                    <div class="word-img" id="wordImg">
                        </div>
                    <div class="word-info">
                        <h2 id="wordText">‚Äî</h2>
                        <div class="meta" id="wordTrans">Traduction ‚Äî</div>
                        <div class="tags">
                            <div class="chip" id="wordPos">part of speech</div>
                            <div class="chip" id="wordSource">source</div>
                        </div>
                        <p class="def" id="wordDef">D√©finition...</p>

                        <div class="audio-controls">
                            <button id="speakBtn" class="icon-btn" title="√âcouter la prononciation"><i class="fas fa-volume-high"></i></button>
                            <button id="favoriteBtn" class="icon-btn" title="Ajouter aux favoris"><i class="fas fa-star"></i></button>
                            <button id="copyBtn" class="icon-btn" title="Copier le mot"><i class="fas fa-copy"></i></button>
                            <div style="flex:1"></div>
                            <small class="muted" id="apiStatus">API: ready</small>
                        </div>

                        <div class="example" id="wordExample">Exemple : ‚Äî</div>
                    </div>
                </div>

                <div class="mini-grid">
                    <div class="small-card">
                        <h4>Mini-quiz express</h4>
                        <div id="miniQuizBox">
                            <p class="muted">R√©ponds √† la question :</p>
                            <div id="miniQuestion" style="margin:10px 0;font-weight:700">‚Äî</div>
                            <input id="miniAnswer" placeholder="Ta r√©ponse" style="padding:8px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);width:100%" />
                            <div style="display:flex;gap:8px;margin-top:8px">
                                <button id="miniCheck" class="btn primary">Valider</button>
                                <button id="miniSkip" class="btn ghost">Passer</button>
                            </div>
                            <div id="miniResult" style="margin-top:8px;color:var(--muted)"></div>
                        </div>
                    </div>

                    <div class="small-card">
                        <h4>Prononciation & R√©p√©tition</h4>
                        <p class="muted">Utilise la voix int√©gr√©e pour prononcer et r√©p√©ter la mot.</p>
                        <div style="display:flex;gap:8px;margin-top:10px">
                            <button id="speakSlow" class="btn ghost"><i class="fas fa-turtle"></i>&nbsp; lent</button>
                            <button id="speakNormal" class="btn primary"><i class="fas fa-forward"></i>&nbsp; normal</button>
                            <button id="speakFast" class="btn ghost"><i class="fas fa-rocket"></i>&nbsp; rapide</button>
                        </div>
                        <div style="margin-top:10px" class="muted">Voix disponible: <span id="voiceName">n/a</span></div>
                    </div>
                </div>

            </div>

            <div style="height:14px"></div>
            <div class="panel fade-up">
                <h3 style="margin:0 0 12px 0;color:var(--accent)">Mots r√©cents</h3>
                <div id="wordsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px"></div>
                <div style="height:10px"></div>
                <div class="log" id="apiLogs"></div>
            </div>
        </div>

        <div class="side">
            <div class="panel chart-card fade-up">
                <h4 style="margin:0 0 8px 0;color:var(--accent)">Progression (7 derniers jours)</h4>
                <canvas id="barChart" height="160"></canvas>
            </div>

            <div class="panel chart-card fade-up">
                <h4 style="margin:0 0 8px 0;color:var(--accent)">Progression cumul√©e</h4>
                <canvas id="lineChart" height="140"></canvas>
            </div>

            <div class="panel chart-card fade-up">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <h4 style="margin:0;color:var(--accent)">Favoris</h4>
                    <button id="clearFavs" class="btn ghost">Tout supprimer</button>
                </div>
                <div class="fav-list" id="favList"></div>
            </div>

            <div class="panel chart-card fade-up">
                <h4 style="margin:0 0 8px 0;color:var(--accent)">Stats rapides</h4>
                <div class="stat-row"><div class="muted">Mots appris (total)</div><div id="totalLearned">0</div></div>
                <div class="stat-row"><div class="muted">Mots aujourd'hui</div><div id="todayCount">0</div></div>
                <div class="stat-row"><div class="muted">Mots favoris</div><div id="favCount">0</div></div>
                <div style="height:10px"></div>
                <div style="font-size:0.85rem;color:var(--muted)">Conseil : clique sur ‚≠ê pour ajouter un mot aux favoris.</div>
            </div>
        </div>
    </div>

    <footer>
        <span class="flag palestine" title="Palestine"></span>
        <span class="flag ukraine" title="Ukraine"></span>
        &nbsp;&nbsp;¬© 2025 Daily English+ ‚Ä¢ iOS glass design ‚Ä¢ DictionaryAPI + MyMemory ‚Ä¢ Offline-ready
    </footer>
</div>

<button id="settings-btn" title="R√©glages du th√®me"><i class="fas fa-cog"></i></button>

<div id="settings-panel">
    <h4>R√©glages du Th√®me</h4>
    
    <div class="setting-group">
        <label for="userNameInput">Votre Nom</label>
        <input type="text" id="userNameInput" placeholder="Ex: Jean" style="width:100%; padding:8px; border-radius:8px; border:1px solid rgba(15,23,42,0.1); background: var(--input-bg); color: var(--text-color);">
    </div>

    <div class="setting-group">
        <label>Mode Affichage</label>
        <div class="theme-select" id="theme-mode-select">
            <button data-mode="light" class="active"><i class="fas fa-sun"></i> Clair</button>
            <button data-mode="dark"><i class="fas fa-moon"></i> Sombre</button>
        </div>
    </div>

    <div class="setting-group">
        <label>Couleur d'Accentuation</label>
        <div class="color-select" id="theme-color-select">
            <button data-color="violet" class="violet active" title="Violet"></button>
            <button data-color="green" class="green" title="Vert"></button>
            <button data-color="blue" class="blue" title="Bleu"></button>
        </div>
    </div>
    
    <div class="setting-group" style="border-top:1px solid rgba(15,23,42,0.1); padding-top:10px;">
        <label for="voiceAnnounceToggle">Annonce Vocale de Bienvenue</label>
        <input type="checkbox" id="voiceAnnounceToggle" style="margin-top:5px;"> (Dit "Hello, {Nom}" au d√©marrage)
    </div>
</div>

<script>
/* ------------------ Data / storage init ------------------ */
let progress = JSON.parse(localStorage.getItem("englishProgress")) || { 
    daily: [], 
    settings: { 
        wordsPerDay: 5, 
        theme: 'light', 
        color: 'violet',
        userName: '', // NEW: User Name
        voiceAnnounce: true // NEW: Voice Announce 
    }, 
    usedWords: [], 
    favorites: [] 
};

// Ensure settings object exists and has new defaults
if (!progress.settings) progress.settings = { wordsPerDay: 5, theme: 'light', color: 'violet', userName: '', voiceAnnounce: true };
if (typeof progress.settings.userName === 'undefined') progress.settings.userName = '';
if (typeof progress.settings.voiceAnnounce === 'undefined') progress.settings.voiceAnnounce = true;

if (!Array.isArray(progress.usedWords)) progress.usedWords = [];
if (!Array.isArray(progress.daily)) progress.daily = [];
if (!Array.isArray(progress.favorites)) progress.favorites = [];


const todayStr = new Date().toLocaleDateString();
document.getElementById('todayDate').textContent = todayStr;

let currentWords = []; // today's words objects
let currentIndex = 0;
let chartBar = null, chartLine = null;

/* ------------------ helpers ------------------ */
function log(msg){
    const el = document.getElementById('apiLogs');
    const time = new Date().toLocaleTimeString();
    el.innerHTML = `<div style="margin-bottom:8px"><small style="color:var(--muted)">${time}</small> ‚Äî ${msg}</div>` + el.innerHTML;
}
function saveProgress(){ localStorage.setItem('englishProgress', JSON.stringify(progress)); updateSideStats(); }
function uniqueRandomWord(list){
    return list[Math.floor(Math.random()*list.length)];
}
function sanitize(text){ return (text||'').replace(/\s+/g,' ').trim(); }

/* ------------------ word source list ------------------ */
const seedWords = ["apple","book","happy","sun","water","dog","cat","tree","house","love","hello","goodbye","thank","please","yes","no","computer","internet","music","friend","family","work","school","time","food","sport","game","city","car","phone","dream","light","smile","rain","star","peace","ocean","mountain","coffee"];

/* ------------------ Theme Logic (UPDATED) ------------------ */

function applyTheme(theme, color) {
    const body = document.getElementById('app-body');
    const root = document.documentElement;

    // Apply Mode (Light/Dark)
    body.classList.toggle('dark-mode', theme === 'dark');
    root.style.setProperty('--theme-mode', theme);

    // Apply Color
    body.classList.remove('theme-violet', 'theme-green', 'theme-blue');
    body.classList.add(`theme-${color}`);
    
    // Update settings
    progress.settings.theme = theme;
    progress.settings.color = color;
    saveProgress();

    // Update UI buttons
    document.querySelectorAll('#theme-mode-select button').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-mode') === theme);
    });
    document.querySelectorAll('#theme-color-select button').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-color') === color);
    });
    
    // Rerender charts to update colors
    if (chartBar) renderCharts(); 
}

// Event listeners for settings panel
document.getElementById('settings-btn').addEventListener('click', () => {
    document.getElementById('settings-panel').classList.toggle('open');
});

document.getElementById('theme-mode-select').addEventListener('click', (e) => {
    const mode = e.target.closest('button')?.getAttribute('data-mode');
    if (mode) applyTheme(mode, progress.settings.color);
});

document.getElementById('theme-color-select').addEventListener('click', (e) => {
    const color = e.target.closest('button')?.getAttribute('data-color');
    if (color) applyTheme(progress.settings.theme, color);
});

// NEW: Name input handler
document.getElementById('userNameInput').addEventListener('input', (e) => {
    progress.settings.userName = e.target.value.trim();
    saveProgress();
    updateHeaderTitle();
});

// NEW: Voice Announce handler
document.getElementById('voiceAnnounceToggle').addEventListener('change', (e) => {
    progress.settings.voiceAnnounce = e.target.checked;
    saveProgress();
});


/* ------------------ APIs: Dictionary + MyMemory (UNCHANGED) ------------------ */
async function fetchWordData(wordCandidate){
    // ensure usedWords array exists
    if (!Array.isArray(progress.usedWords)) progress.usedWords = [];
    let attempts = 0;
    let word = wordCandidate || uniqueRandomWord(seedWords);

    // pick an unused word if possible (limit attempts)
    while(progress.usedWords.includes(word) && attempts < 12){
        word = uniqueRandomWord(seedWords);
        attempts++;
    }
    // if still used, allow reuse (after many attempts)
    log(`Recherche d√©finition pour : <strong>${word}</strong>`);
    try {
        // Dictionary API
        const dict = await axios.get(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
        const data = dict.data && dict.data[0];
        const meaning = data?.meanings?.[0] || {};
        const def = meaning.definitions?.[0]?.definition || 'D√©finition indisponible';
        const part = meaning.partOfSpeech || '‚Äî';

        // MyMemory translation
        log(`Traduction via MyMemory...`);
        let translation = word;
        try {
            // Note: API in the console error image (api.dictionaryapi.de_ies) seems incorrect. Using .dev which is the standard.
            const transRes = await axios.get(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|fr`);
            translation = transRes.data?.responseData?.translatedText || word;
        } catch(e) {
            log('Erreur traduction ‚Äî fallback utilis√©');
            translation = word;
        }

        // example if present
        const example = meaning.definitions?.[0]?.example || `${word} is used in a sentence.`;

        // image via Unsplash source (no key)
        const imageUrl = `https://source.unsplash.com/featured/400x400/?${encodeURIComponent(word)}`;

        // add to used list
        if (!progress.usedWords.includes(word)) progress.usedWords.push(word);
        saveProgress();

        return { english: word, french: translation, definition: def, pos: part, example, image: imageUrl };
    } catch (err) {
        // Log the actual error which might be a 404 from the dictionary
        log(`Erreur Dictionary API pour "${word}". Message: ${err.message || 'Unknown'}. Utilisation d'un fallback.`);
        
        // fallback object
        if (!progress.usedWords.includes(word)) progress.usedWords.push(word);
        saveProgress();
        return { english: word, french: word, definition: 'D√©finition indisponible', pos: '‚Äî', example: `${word} (exemple)`, image: `https://source.unsplash.com/featured/400x400/?${encodeURIComponent(word)}` };
    }
}


/* ------------------ UI renderers (UPDATED) ------------------ */
function updateHeaderTitle(){
    const titleEl = document.getElementById('app-title-display');
    const name = progress.settings.userName;
    const fullTitle = `Daily English+ ‚Äî Premium`;
    const mobileTitle = `Daily English+`;

    if (name) {
        // Full greeting for wide screens (header-title-full)
        titleEl.querySelector('.header-title-full').textContent = `Hi, ${name}`;
        // Mobile title remains "Daily English+" (header-title-mobile)
        titleEl.querySelector('.header-title-mobile').textContent = mobileTitle;
    } else {
        titleEl.querySelector('.header-title-full').textContent = fullTitle;
        titleEl.querySelector('.header-title-mobile').textContent = mobileTitle;
    }
}

function renderMainWord(obj){
    const imgDiv = document.getElementById('wordImg');
    imgDiv.innerHTML = `<img src="${obj.image}" alt="${obj.english}" onerror="this.src='https://images.unsplash.com/photo-1503264116251-35a269479413?auto=format&fit=crop&w=400&q=60'">`;

    document.getElementById('wordText').textContent = obj.english;
    document.getElementById('wordTrans').textContent = `‚Üí ${obj.french}`;
    document.getElementById('wordDef').textContent = obj.definition;
    document.getElementById('wordPos').textContent = obj.pos || '‚Äî';
    document.getElementById('wordSource').textContent = 'Dictionary API';
    document.getElementById('wordExample').textContent = `Exemple : ${obj.example || '‚Äî'}`;
}

function renderWordsGrid(list){
    const grid = document.getElementById('wordsGrid');
    grid.innerHTML = '';
    list.forEach((w, idx) => {
        const el = document.createElement('div');
        el.className = 'word-card';
        el.style.transition = 'transform .25s ease';
        el.innerHTML = `
            <div style="display:flex;gap:10px;align-items:center">
                <div style="width:64px;height:64px;border-radius:10px;overflow:hidden;flex-shrink:0">
                    <img src="${w.image}" style="width:100%;height:100%;object-fit:cover" alt="${w.english}" onerror="this.src='words-image-back.png'">
                </div>
                <div style="flex:1">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div style="font-weight:700;color:var(--accent)">${w.english}</div>
                        <div style="font-size:0.85rem;color:var(--muted)">${w.pos || ''}</div>
                    </div>
                    <div style="color:var(--muted);font-size:0.95rem;margin-top:6px">${w.french}</div>
                </div>
            </div>
            <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
                <button class="icon-btn" data-idx="${idx}" data-act="play"><i class="fas fa-volume-up"></i></button>
                <button class="icon-btn" data-idx="${idx}" data-act="fav"><i class="fas fa-star"></i></button>
            </div>
        `;
        grid.appendChild(el);
    });

    // attach small handlers
    grid.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
            const act = btn.getAttribute('data-act');
            const idx = parseInt(btn.getAttribute('data-idx'));
            const item = currentWords[idx];
            if(act==='play'){ speak(item.english,1.0); }
            if(act==='fav'){ toggleFavorite(item); }
        });
    });
}

function updateFavList(){
    const list = document.getElementById('favList');
    list.innerHTML = '';
    progress.favorites.forEach((f, i)=>{
        const el = document.createElement('div');
        el.className = 'fav-item';
        el.innerHTML = `<div style="width:42px;height:42px;border-radius:8px;overflow:hidden"><img src="${f.image}" style="width:100%;height:100%;object-fit:cover" onerror="this.src='https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=400&q=60'"></div>
                        <div style="flex:1">
                            <div class="fav-word">${f.english}</div>
                            <div class="fav-trans">${f.french}</div>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:6px">
                            <button class="btn ghost" data-i="${i}" title="Prononcer">üîä</button>
                            <button class="btn ghost" data-i="${i}" title="Supprimer">üóëÔ∏è</button>
                        </div>`;
        list.appendChild(el);
    });
    // handlers
    list.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
            const i = parseInt(btn.getAttribute('data-i'));
            const txt = btn.title || '';
            if(btn.title==='Prononcer') speak(progress.favorites[i].english,1.0);
            else { progress.favorites.splice(i,1); saveProgress(); updateFavList(); }
        });
    });
}


/* ------------------ Speech (pronunciation) ------------------ */
let synth = window.speechSynthesis;
let chosenVoice = null;
function populateVoice(){
    const voices = synth.getVoices();
    // pick a suitable english voice (or french for welcome message)
    chosenVoice = voices.find(v => v.lang.toLowerCase().startsWith('en')) || voices[0] || null;
    document.getElementById('voiceName').textContent = chosenVoice ? `${chosenVoice.name} (${chosenVoice.lang})` : 'n/a';
}
function speak(text, rate=1.0){
    if(!synth) { alert('Synth√®se vocale non disponible'); return; }
    const u = new SpeechSynthesisUtterance(text);
    if(chosenVoice) u.voice = chosenVoice;
    u.rate = rate;
    synth.cancel(); // stop previous
    synth.speak(u);
}

// NEW: Welcome voice announcement
function announceWelcome(){
    const name = progress.settings.userName;
    if(progress.settings.voiceAnnounce && name && synth){
        const text = `Hello ${name}, welcome back!`;
        const frenchVoice = synth.getVoices().find(v => v.lang.toLowerCase().startsWith('fr'));
        
        const u = new SpeechSynthesisUtterance(text);
        // Use a french voice for the welcome message if available, else a default
        u.voice = frenchVoice || chosenVoice;
        u.rate = 1.0;
        synth.speak(u);
        log(`Annonce vocale: "${text}"`);
    }
}


/* ------------------ Chart rendering (UPDATED) ------------------ */
function renderCharts(){
    // Get accent colors from current CSS variables
    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
    const contrastColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-2').trim();
    const accentColorRGB = `rgba(${parseInt(accentColor.slice(1,3), 16)}, ${parseInt(accentColor.slice(3,5), 16)}, ${parseInt(accentColor.slice(5,7), 16)}, 0.85)`;
    const contrastColorRGB = `rgba(${parseInt(contrastColor.slice(1,3), 16)}, ${parseInt(contrastColor.slice(3,5), 16)}, ${parseInt(contrastColor.slice(5,7), 16)}, 0.12)`;


    // prepare last 7 days array
    const last7 = [...Array(7)].map((_,i)=>{
        const d = new Date(); d.setDate(d.getDate() - (6 - i));
        const s = d.toLocaleDateString();
        return progress.daily.find(x=>x.date===s)?.words?.length || 0;
    });
    // cumulative
    const cumul = last7.reduce((arr,val,idx)=>{
        if(idx===0) return [val];
        arr.push(arr[idx-1]+val);
        return arr;
    },[]);

    // destroy old charts
    if(chartBar) chartBar.destroy();
    if(chartLine) chartLine.destroy();

    const ctxBar = document.getElementById('barChart').getContext('2d');
    chartBar = new Chart(ctxBar, {
        type:'bar',
        data:{
            labels: (()=>{const a=[]; for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i); a.push(d.toLocaleDateString());} return a;})(),
            datasets:[{
                label:'Mots appris', 
                data:last7, 
                backgroundColor: accentColorRGB, // Use accent color
                borderRadius:6
            }]
        },
        options:{
            plugins:{legend:{display:false}},
            scales:{
                y:{beginAtZero:true, grid: {color: 'rgba(15,23,42,0.06)'}},
                x: {grid: {display: false}}
            }
        }
    });

    const ctxLine = document.getElementById('lineChart').getContext('2d');
    chartLine = new Chart(ctxLine, {
        type:'line',
        data:{
            labels: chartBar.data.labels,
            datasets:[{
                label:'Cumul',
                data:cumul,
                fill:true,
                borderColor:contrastColor, // Use contrast color
                tension:0.35,
                backgroundColor:contrastColorRGB, // Use contrast color transparent
                pointRadius:4
            }]
        },
        options:{
            plugins:{legend:{display:false}},
            scales:{
                y:{beginAtZero:true, grid: {color: 'rgba(15,23,42,0.06)'}},
                x: {grid: {display: false}}
            }
        }
    });
}

/* ------------------ Flow: generate / display words (UNCHANGED) ------------------ */
async function generateTodayWords(count){
    document.getElementById('apiStatus').textContent = 'R√©cup√©ration...';
    const arr = [];
    for(let i=0;i<count;i++){
        const obj = await fetchWordData(); // picks random unused word
        arr.push(obj);
    }
    // store today's set (replace if already exists)
    const today = new Date().toLocaleDateString();
    // remove existing today's entry
    progress.daily = progress.daily.filter(d=>d.date!==today);
    progress.daily.push({ date: today, words: arr });
    saveProgress();

    currentWords = arr;
    currentIndex = 0;
    renderMainWord(currentWords[0]);
    renderWordsGrid(currentWords);
    setMiniQuestion(currentWords[0]);
    document.getElementById('apiStatus').textContent = 'Pr√™t';
    renderCharts();
}

function updateSideStats(){
    const total = progress.daily.reduce((s,d)=>s + (d.words?.length || 0), 0);
    document.getElementById('totalLearned').textContent = total;
    const today = new Date().toLocaleDateString();
    const todayCount = progress.daily.find(d=>d.date===today)?.words?.length || 0;
    document.getElementById('todayCount').textContent = todayCount;
    document.getElementById('favCount').textContent = progress.favorites.length;
    document.getElementById('todayDate').textContent = today;
}

// (UNCHANGED handlers for startBtn, nextBtn, fav, copy, speak, quiz etc.)

/* ------------------ Init: load today's words (UPDATED) ------------------ */
function loadTodayIfAny(){
    // 1. Apply theme
    applyTheme(progress.settings.theme, progress.settings.color); 
    
    // 2. Load settings for name/voice
    document.getElementById('userNameInput').value = progress.settings.userName;
    document.getElementById('voiceAnnounceToggle').checked = progress.settings.voiceAnnounce;
    updateHeaderTitle(); // Apply name to header

    // 3. Load daily words or generate new ones
    const today = new Date().toLocaleDateString();
    const day = progress.daily.find(d=>d.date===today);
    if(day && Array.isArray(day.words) && day.words.length>0){
        currentWords = day.words;
        currentIndex = 0;
        renderMainWord(currentWords[0]);
        renderWordsGrid(currentWords);
        setMiniQuestion(currentWords[0]);
    } else {
        // generate default with selected count
        const cnt = parseInt(document.getElementById('wordsPerDay').value || '5');
        generateTodayWords(cnt);
    }
    updateFavList();
    updateSideStats();
    renderCharts();
    
    // 4. Announce welcome if enabled
    announceWelcome();
}

/* ------------------ voice populate and event when voices loaded ------------------ */
if (typeof speechSynthesis !== 'undefined') {
    populateVoice();
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoice;
    }
}

/* ------------------ Start ------------------ */
loadTodayIfAny();
log('Application initialis√©e. Bonne session !');

</script>
</body>
</html>