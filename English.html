<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Daily English+ ‚Äî Premium iOS Style</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* ---------------- Theme / Reset ---------------- */
    :root{
        --bg-grad: linear-gradient(135deg,#eef6ff 0%, #f8f9ff 45%, #fff 100%);
        --glass-bg: rgba(255,255,255,0.55);
        --glass-border: rgba(255,255,255,0.6);
        --accent: #6c5ce7;
        --accent-2: #00c2b8;
        --muted: #6b7280;
        --card-radius: 20px;
        --shadow: 0 10px 30px rgba(17,24,39,0.08);
        --glass-shadow: 0 6px 20px rgba(108,92,231,0.08);
        --glass-border-2: rgba(255,255,255,0.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;color:#0f172a;background:var(--bg-grad);-webkit-font-smoothing:antialiased}
    /* Background illustration subtle */
    body::before{
        content:"";
        position:fixed;inset:0;
        background-image: radial-gradient(circle at 10% 10%, rgba(108,92,231,0.06) 0 200px, transparent 201px),
                          radial-gradient(circle at 90% 80%, rgba(0,194,184,0.04) 0 240px, transparent 241px);
        pointer-events:none;
        z-index:0;
    }

    /* --------------- Layout --------------- */
    .wrap{max-width:1250px;margin:28px auto;padding:18px;position:relative;z-index:1}
    header.app-header{
        display:flex;align-items:center;gap:16px;
        background: linear-gradient(90deg, rgba(255,255,255,0.22), rgba(255,255,255,0.12));
        border-radius: 18px;
        padding:18px 20px;
        box-shadow:var(--glass-shadow);
        backdrop-filter: blur(8px) saturate(120%);
        border:1px solid var(--glass-border-2);
        margin-bottom:18px;
    }
    header.app-header .logo{
        width:58px;height:58px;border-radius:14px;
        display:flex;align-items:center;justify-content:center;
        background: linear-gradient(135deg,var(--accent), #9f86ff);
        color:white;font-size:22px;box-shadow: 0 6px 18px rgba(108,92,231,0.18);
    }
    header.app-header .meta h1{margin:0;font-size:1.45rem;letter-spacing:0.2px}
    header.app-header .meta p{margin:3px 0 0;color:var(--muted);font-size:0.95rem}

    /* Search bar in header */
    .search-bar {
        margin-left: auto; /* Push search bar to the right */
        display: flex;
        align-items: center;
        width: 300px; /* Adjust width as needed */
        position: relative;
    }
    .search-bar input {
        width: 100%;
        padding: 10px 14px;
        border-radius: 999px;
        border: 1px solid rgba(15,23,42,0.06);
        background: rgba(255,255,255,0.85);
        transition: border-color 0.2s;
    }
    .search-bar input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(108,92,231,0.2);
    }
    .search-bar button {
        position: absolute;
        right: 1px;
        background: var(--accent);
        color: white;
        border: none;
        padding: 9px 12px;
        border-radius: 999px;
        cursor: pointer;
    }

    /* Grid */
    .grid{
        display:grid;
        grid-template-columns: 1fr 380px;
        gap:18px;
    }
    @media (max-width:1050px){ .grid{grid-template-columns:1fr} }

    /* Left column - learning area */
    .panel{
        background:var(--glass-bg);
        border-radius:var(--card-radius);
        padding:18px;
        box-shadow:var(--shadow);
        border:1px solid var(--glass-border);
        backdrop-filter: blur(10px);
    }

    .top-controls{display:flex;gap:12px;align-items:center;margin-bottom:12px}
    .select, .btn{
        border-radius:999px;padding:10px 14px;border:none;font-weight:600;cursor:pointer;
    }
    .select{background:rgba(255,255,255,0.85);border:1px solid rgba(15,23,42,0.04)}
    .btn.primary{background:linear-gradient(90deg,var(--accent), #8a7bff);color:white;box-shadow:0 8px 20px rgba(108,92,231,0.12)}
    .btn.ghost{background:transparent;border:1px solid rgba(15,23,42,0.06);color:var(--muted)}

    /* Word Card big */
    .word-main{
        display:grid;grid-template-columns: 120px 1fr;gap:14px;align-items:center;
        padding:16px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.55));
        border:1px solid rgba(255,255,255,0.5);margin-bottom:14px;
    }
    .word-img{width:120px;height:120px;border-radius:12px;overflow:hidden;flex-shrink:0;background:#eee}
    .word-img img{width:100%;height:100%;object-fit:cover;display:block}
    .word-info h2{margin:0;font-size:1.6rem;color:var(--accent)}
    .word-info .meta{color:var(--muted);margin-top:6px;font-size:0.95rem}
    .word-info p.def{margin:10px 0 0;color:#0f172a;opacity:0.9}
    .tags{display:flex;gap:8px;margin-top:10px}

    .chip{
        background:rgba(255,255,255,0.85);padding:8px 12px;border-radius:999px;border:1px solid rgba(15,23,42,0.04);
        font-weight:600;color:var(--muted);font-size:0.9rem;
    }

    /* Pronunciation & audio */
    .audio-controls{display:flex;gap:8px;margin-top:12px;align-items:center}
    .icon-btn{background:transparent;border:1px solid rgba(15,23,42,0.06);padding:10px;border-radius:12px;cursor:pointer}

    /* Example sentence box */
    .example{
        margin-top:12px;padding:12px;border-radius:12px;background:linear-gradient(90deg, rgba(0,194,184,0.04), rgba(108,92,231,0.02));
        font-style:italic;color:#0f172a;
    }

    /* Mini quiz & favourites */
    .mini-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    @media (max-width:620px){ .mini-grid{grid-template-columns:1fr} }

    .small-card{padding:12px;border-radius:12px;background:rgba(255,255,255,0.85);border:1px solid rgba(15,23,42,0.04)}
    .small-card h4{margin:0 0 8px 0;color:var(--accent)}

    /* Right column - stats / history */
    .side{
        display:flex;flex-direction:column;gap:12px;
    }
    .chart-card{padding:12px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.8));border:1px solid rgba(15,23,42,0.04)}
    .stat-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed rgba(15,23,42,0.03)}
    .stat-row:last-child{border-bottom:none}
    .muted{color:var(--muted);font-size:0.92rem}

    /* Favorites list */
    .fav-list{display:flex;flex-direction:column;gap:8px;max-height:260px;overflow:auto;padding-right:6px}
    .fav-item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;background:rgba(255,255,255,0.85);border:1px solid rgba(15,23,42,0.04)}
    .fav-item .fav-word{font-weight:700;color:var(--accent);}
    .fav-item .fav-trans{color:var(--muted);font-size:0.9rem}

    /* logs */
    .log{font-size:0.85rem;color:var(--muted);max-height:160px;overflow:auto;padding:8px;border-radius:10px;background:rgba(255,255,255,0.8);border:1px solid rgba(15,23,42,0.03)}
    /* animations */
    .fade-up{animation:fadeUp .5s cubic-bezier(.2,.9,.3,1)}
    @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:0.9rem}
</style>
</head>
<body>
<div class="wrap">
    <header class="app-header">
        <div class="logo"><i class="fas fa-atom"></i></div>
        <div class="meta">
            <h1>Daily English+ ‚Äî Premium</h1>
            <p>Style iOS ‚Ä¢ glass ‚Ä¢ rounded ‚Ä¢ images motivantes ‚Ä¢ voix int√©gr√©e</p>
        </div>

        <div class="search-bar">
            <input type="text" id="searchWordInput" placeholder="Chercher un mot (ex: hello)" onkeydown="if(event.key === 'Enter') document.getElementById('searchWordBtn').click()">
            <button id="searchWordBtn" title="Chercher"><i class="fas fa-search"></i></button>
        </div>
    </header>

    <div class="grid">
        <div>
            <div class="panel fade-up">
                <div class="top-controls">
                    <select id="wordsPerDay" class="select" title="Nombre de mots par jour">
                        <option value="3">3 mots / jour</option>
                        <option value="5" selected>5 mots / jour</option>
                        <option value="8">8 mots / jour</option>
                    </select>
                    <button id="startBtn" class="btn primary"><i class="fas fa-play"></i>&nbsp;D√©marrer</button>
                    <button id="nextBtn" class="btn ghost"><i class="fas fa-random"></i>&nbsp;Nouveaux</button>
                    <div style="flex:1"></div>
                    <div class="muted">Mode iOS ‚Ä¢ <strong id="todayDate"></strong></div>
                </div>

                <div id="wordArea" class="word-main">
                    <div class="word-img" id="wordImg">
                        </div>
                    <div class="word-info">
                        <h2 id="wordText">‚Äî</h2>
                        <div class="meta" id="wordTrans">Traduction ‚Äî</div>
                        <div class="tags">
                            <div class="chip" id="wordPos">part of speech</div>
                            <div class="chip" id="wordSource">source</div>
                        </div>
                        <p class="def" id="wordDef">D√©finition...</p>

                        <div class="audio-controls">
                            <button id="speakBtn" class="icon-btn" title="√âcouter la prononciation"><i class="fas fa-volume-high"></i></button>
                            <button id="favoriteBtn" class="icon-btn" title="Ajouter aux favoris"><i class="fas fa-star"></i></button>
                            <button id="copyBtn" class="icon-btn" title="Copier le mot"><i class="fas fa-copy"></i></button>
                            <div style="flex:1"></div>
                            <small class="muted" id="apiStatus">API: ready</small>
                        </div>

                        <div class="example" id="wordExample">Exemple : ‚Äî</div>
                    </div>
                </div>

                <div class="mini-grid">
                    <div class="small-card">
                        <h4>Mini-quiz express</h4>
                        <div id="miniQuizBox">
                            <p class="muted">R√©ponds √† la question :</p>
                            <div id="miniQuestion" style="margin:10px 0;font-weight:700">‚Äî</div>
                            <input id="miniAnswer" placeholder="Ta r√©ponse" style="padding:8px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);width:100%" />
                            <div style="display:flex;gap:8px;margin-top:8px">
                                <button id="miniCheck" class="btn primary">Valider</button>
                                <button id="miniSkip" class="btn ghost">Passer</button>
                            </div>
                            <div id="miniResult" style="margin-top:8px;color:var(--muted)"></div>
                        </div>
                    </div>

                    <div class="small-card">
                        <h4>Prononciation & R√©p√©tition</h4>
                        <p class="muted">Utilise la voix int√©gr√©e pour prononcer et r√©p√©ter la mot.</p>
                        <div style="display:flex;gap:8px;margin-top:10px">
                            <button id="speakSlow" class="btn ghost"><i class="fas fa-turtle"></i>&nbsp; lent</button>
                            <button id="speakNormal" class="btn primary"><i class="fas fa-forward"></i>&nbsp; normal</button>
                            <button id="speakFast" class="btn ghost"><i class="fas fa-rocket"></i>&nbsp; rapide</button>
                        </div>
                        <div style="margin-top:10px" class="muted">Voix disponible: <span id="voiceName">n/a</span></div>
                    </div>
                </div>

            </div>

            <div style="height:14px"></div>
            <div class="panel fade-up">
                <h3 style="margin:0 0 12px 0;color:var(--accent)">Mots r√©cents</h3>
                <div id="wordsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px"></div>
                <div style="height:10px"></div>
                <div class="log" id="apiLogs"></div>
            </div>
        </div>

        <div class="side">
            <div class="panel chart-card fade-up">
                <h4 style="margin:0 0 8px 0;color:var(--accent)">Progression (7 derniers jours)</h4>
                <canvas id="barChart" height="160"></canvas>
            </div>

            <div class="panel chart-card fade-up">
                <h4 style="margin:0 0 8px 0;color:var(--accent)">Progression cumul√©e</h4>
                <canvas id="lineChart" height="140"></canvas>
            </div>

            <div class="panel chart-card fade-up">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <h4 style="margin:0;color:var(--accent)">Favoris</h4>
                    <button id="clearFavs" class="btn ghost">Tout supprimer</button>
                </div>
                <div class="fav-list" id="favList"></div>
            </div>

            <div class="panel chart-card fade-up">
                <h4 style="margin:0 0 8px 0;color:var(--accent)">Stats rapides</h4>
                <div class="stat-row"><div class="muted">Mots appris (total)</div><div id="totalLearned">0</div></div>
                <div class="stat-row"><div class="muted">Mots aujourd'hui</div><div id="todayCount">0</div></div>
                <div class="stat-row"><div class="muted">Mots favoris</div><div id="favCount">0</div></div>
                <div style="height:10px"></div>
                <div style="font-size:0.85rem;color:var(--muted)">Conseil : clique sur ‚≠ê pour ajouter un mot aux favoris.</div>
            </div>
        </div>
    </div>

    <footer>¬© 2025 Daily English+ ‚Ä¢ iOS glass design ‚Ä¢ DictionaryAPI + MyMemory ‚Ä¢ Offline-ready</footer>
</div>

<script>
/* ------------------ Data / storage init ------------------ */
let progress = JSON.parse(localStorage.getItem("englishProgress")) || { daily: [], settings: { wordsPerDay: 5 }, usedWords: [], favorites: [] };
if (!Array.isArray(progress.usedWords)) progress.usedWords = [];
if (!Array.isArray(progress.daily)) progress.daily = [];
if (!Array.isArray(progress.favorites)) progress.favorites = [];

const todayStr = new Date().toLocaleDateString();
document.getElementById('todayDate').textContent = todayStr;

let currentWords = []; // today's words objects
let currentIndex = 0;
let chartBar = null, chartLine = null;
let allEnglishWords = []; // Global list of all possible words loaded from TXT

/* ------------------ helpers ------------------ */
function log(msg){
    const el = document.getElementById('apiLogs');
    const time = new Date().toLocaleTimeString();
    el.innerHTML = `<div style="margin-bottom:8px"><small style="color:var(--muted)">${time}</small> ‚Äî ${msg}</div>` + el.innerHTML;
}
function saveProgress(){ localStorage.setItem('englishProgress', JSON.stringify(progress)); updateSideStats(); }
function sanitize(text){ return (text||'').replace(/\s+/g,' ').trim(); }

/* ------------------ LOCAL LIST LOADER (NOUVEAU) ------------------ */
async function loadEnglishWordsList() {
    log('Chargement de la liste de mots depuis english_words.txt...');
    try {
        // Fetch the local file content
        const response = await axios.get('english_words.txt');
        
        // Split by newline, map to lowercase/sanitize, and filter out empty lines/whitespace
        allEnglishWords = response.data.split('\n')
                                 .map(word => sanitize(word).toLowerCase())
                                 .filter(word => word.length > 1);
        log(`Liste de mots charg√©e ! ${allEnglishWords.length} mots disponibles.`);
        return allEnglishWords;
    } catch (error) {
        log('ERREUR: Impossible de charger english_words.txt. Utilisation de la liste de secours int√©gr√©e.');
        // Fallback list if the file cannot be loaded (ex: local development, network error)
        allEnglishWords = ["developer", "internet", "coding", "solution", "project", "github", "page", "server", "javascript", "axios"]; 
        return allEnglishWords;
    }
}


/* ------------------ APIs: Dictionary + MyMemory ------------------ */

// Fonction unifi√©e pour chercher les d√©tails, la d√©finition et la traduction d'un mot anglais
async function getWordDetails(englishWord, source = 'Local List') {
    englishWord = sanitize(englishWord).toLowerCase();
    let data = null;

    if (!englishWord) return null;

    log(`Recherche de d√©tails pour : <strong>${englishWord}</strong>`);

    try {
        // 1. Dictionary API (Definition) - Utilise bien le domaine .dev
        const dict = await axios.get(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(englishWord)}`);
        data = dict.data && dict.data[0];
    } catch (err) {
        log(`Erreur Dictionary API pour "${englishWord}".`);
        // Continue to translation even if definition fails
    }
    
    // Extract info (will be undefined if data is null)
    const meaning = data?.meanings?.[0] || {};
    const def = meaning.definitions?.[0]?.definition || 'D√©finition indisponible';
    const part = meaning.partOfSpeech || '‚Äî';
    const example = meaning.definitions?.[0]?.example || `${englishWord} is used in a sentence.`;

    // 2. MyMemory translation EN -> FR
    log(`Traduction via MyMemory...`);
    let translation = englishWord;
    try {
        const transRes = await axios.get(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(englishWord)}&langpair=en|fr`);
        translation = transRes.data?.responseData?.translatedText || englishWord;
    } catch(e) {
        log('Erreur traduction MyMemory ‚Äî anglais par d√©faut utilis√©');
        translation = englishWord;
    }

    // 3. Image via Unsplash source (no key)
    const imageUrl = `https://source.unsplash.com/featured/400x400/?${encodeURIComponent(englishWord)}`;

    // Si la d√©finition a √©chou√©, on retourne null sauf si on est en recherche manuelle o√π l'on garde le mot non-d√©fini
    if (!data && source !== 'Manual Search') return null; 

    // Retourne l'objet complet
    return { english: englishWord, french: translation, definition: def, pos: part, example, image: imageUrl, source: source };
}


// Fonction pour g√©n√©rer un mot al√©atoire non utilis√© √† partir de la liste locale
async function fetchWordData(){
    if (!Array.isArray(progress.usedWords)) progress.usedWords = [];
    if (allEnglishWords.length === 0) {
        await loadEnglishWordsList();
    }

    let attempts = 0;
    let englishWord = '';
    let wordDetails = null;

    // Filtre la liste pour n'utiliser que les mots non encore utilis√©s
    let availableWords = allEnglishWords.filter(word => !progress.usedWords.includes(word));
    
    // Si la liste est vide, on prend n'importe quel mot (r√©utilisation)
    if (availableWords.length === 0) {
        log('Liste de mots uniques √©puis√©e. S√©lection al√©atoire dans la liste totale.');
        availableWords = allEnglishWords;
    }
    
    // Tente de trouver un mot valide 
    while((!wordDetails) && attempts < 20){
        attempts++;
        
        if (availableWords.length === 0) {
            englishWord = "developer"; // Fallback ultime si la liste totale est vide
        } else {
            // Pick a random word from the *available* list
            const randomIndex = Math.floor(Math.random() * availableWords.length);
            englishWord = availableWords.splice(randomIndex, 1)[0]; // Remove from available list to avoid immediate re-pick
        }

        log(`Tentative #${attempts} de recherche via mot local : <strong>${englishWord}</strong>`);
        
        // 1. Obtention des d√©tails du mot (Definition + Translation)
        wordDetails = await getWordDetails(englishWord, 'Local List');
            
        if(wordDetails){
            log(`Mot Anglais trouv√© : ${englishWord}`);
            break; // Mot trouv√©
        } else {
            log(`Mot Anglais "${englishWord}" non valide/trouv√© par Dico API, nouvelle tentative...`);
        }
    }
    
    // Fallback si tout √©choue
    if (!wordDetails) {
        englishWord = "developer"; 
        log(`√âchec des tentatives. Utilisation du mot de secours : <strong>${englishWord}</strong>`);
        wordDetails = await getWordDetails(englishWord, 'API Search') || { english: englishWord, french: 'd√©veloppeur', definition: 'D√©finition indisponible', pos: '‚Äî', example: `${englishWord} (exemple)`, image: `https://source.unsplash.com/featured/400x400/?${encodeURIComponent(englishWord)}`, source: 'API Search' };
    }

    // add to used list and save (uniquement si c'est un mot valide issu du processus normal)
    if (!progress.usedWords.includes(wordDetails.english) && wordDetails.source === 'Local List') {
        progress.usedWords.push(wordDetails.english);
    }
    saveProgress();

    return wordDetails;
}


/* ------------------ UI renderers ------------------ */
function renderMainWord(obj){
    // Utilise la variable obj.source pour savoir quelle source afficher
    const isSearch = obj.source === 'Manual Search';
    const imgDiv = document.getElementById('wordImg');
    imgDiv.innerHTML = `<img src="${obj.image}" alt="${obj.english}" onerror="this.src='https://images.unsplash.com/photo-1503264116251-35a269479413?auto=format&fit=crop&w=400&q=60'">`;

    document.getElementById('wordText').textContent = obj.english;
    document.getElementById('wordTrans').textContent = `‚Üí ${obj.french}`;
    document.getElementById('wordDef').textContent = obj.definition;
    document.getElementById('wordPos').textContent = obj.pos || '‚Äî';
    document.getElementById('wordSource').textContent = isSearch ? 'Recherche Manuelle' : 'Liste Locale';
    document.getElementById('wordExample').textContent = `Exemple : ${obj.example || '‚Äî'}`;
    
    // Disable quiz for manually searched words
    document.getElementById('miniQuizBox').style.opacity = isSearch ? 0.5 : 1;
    document.getElementById('miniQuizBox').style.pointerEvents = isSearch ? 'none' : 'auto';
    document.getElementById('speakBtn').style.pointerEvents = 'auto'; // Re-enable speak button
}

function renderWordsGrid(list){
    const grid = document.getElementById('wordsGrid');
    grid.innerHTML = '';
    // Filter out manual search results if they somehow ended up in currentWords
    list.filter(w => w.source !== 'Manual Search').forEach((w, idx) => {
        const el = document.createElement('div');
        el.className = 'word-card';
        el.style.transition = 'transform .25s ease';
        el.innerHTML = `
            <div style="display:flex;gap:10px;align-items:center">
                <div style="width:64px;height:64px;border-radius:10px;overflow:hidden;flex-shrink:0">
                    <img src="${w.image}" style="width:100%;height:100%;object-fit:cover" alt="${w.english}" onerror="this.src='words-image-back.png'">
                </div>
                <div style="flex:1">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div style="font-weight:700;color:var(--accent)">${w.english}</div>
                        <div style="font-size:0.85rem;color:var(--muted)">${w.pos || ''}</div>
                    </div>
                    <div style="color:var(--muted);font-size:0.95rem;margin-top:6px">${w.french}</div>
                </div>
            </div>
            <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
                <button class="icon-btn" data-idx="${idx}" data-act="play"><i class="fas fa-volume-up"></i></button>
                <button class="icon-btn" data-idx="${idx}" data-act="fav"><i class="fas fa-star"></i></button>
            </div>
        `;
        grid.appendChild(el);
    });

    // attach small handlers
    grid.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
            const act = btn.getAttribute('data-act');
            const idx = parseInt(btn.getAttribute('data-idx'));
            // Use the list that was actually rendered (filtered)
            const listToUse = currentWords.filter(w => w.source !== 'Manual Search');
            const item = listToUse[idx]; 
            if(act==='play'){ speak(item.english,1.0); }
            if(act==='fav'){ toggleFavorite(item); }
        });
    });
}

function updateFavList(){
    const list = document.getElementById('favList');
    list.innerHTML = '';
    progress.favorites.forEach((f, i)=>{
        const el = document.createElement('div');
        el.className = 'fav-item';
        el.innerHTML = `<div style="width:42px;height:42px;border-radius:8px;overflow:hidden"><img src="${f.image}" style="width:100%;height:100%;object-fit:cover" onerror="this.src='https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=400&q=60'"></div>
                        <div style="flex:1">
                            <div class="fav-word">${f.english}</div>
                            <div class="fav-trans">${f.french}</div>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:6px">
                            <button class="btn ghost" data-i="${i}" title="Prononcer">üîä</button>
                            <button class="btn ghost" data-i="${i}" title="Supprimer">üóëÔ∏è</button>
                        </div>`;
        list.appendChild(el);
    });
    // handlers
    list.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
            const i = parseInt(btn.getAttribute('data-i'));
            const txt = btn.title || '';
            if(btn.title==='Prononcer') speak(progress.favorites[i].english,1.0);
            else { progress.favorites.splice(i,1); saveProgress(); updateFavList(); }
        });
    });
}

/* ------------------ Favorites ------------------ */
function toggleFavorite(item){
    if(!item) return;
    const exists = progress.favorites.find(f=>f.english===item.english);
    if(exists){
        progress.favorites = progress.favorites.filter(f=>f.english!==item.english);
        log(`${item.english} retir√© des favoris`);
    } else {
        progress.favorites.unshift(item);
        log(`${item.english} ajout√© aux favoris`);
    }
    saveProgress();
    updateFavList();
}

/* ------------------ Speech (pronunciation) ------------------ */
let synth = window.speechSynthesis;
let chosenVoice = null;
function populateVoice(){
    const voices = synth.getVoices();
    // pick a suitable english voice
    chosenVoice = voices.find(v => v.lang.toLowerCase().startsWith('en')) || voices[0] || null;
    document.getElementById('voiceName').textContent = chosenVoice ? `${chosenVoice.name} (${chosenVoice.lang})` : 'n/a';
}
function speak(text, rate=1.0){
    if(!synth) { alert('Synth√®se vocale non disponible'); return; }
    const u = new SpeechSynthesisUtterance(text);
    if(chosenVoice) u.voice = chosenVoice;
    u.rate = rate;
    synth.cancel(); // stop previous
    synth.speak(u);
}

/* ------------------ Mini Quiz ------------------ */
function setMiniQuestion(wordObj){
    if(!wordObj || wordObj.source === 'Manual Search') {
        document.getElementById('miniQuestion').textContent = `‚Äî`;
        document.getElementById('miniQuizBox').style.opacity = 0.5;
        document.getElementById('miniQuizBox').style.pointerEvents = 'none';
        return; 
    }
    document.getElementById('miniQuizBox').style.opacity = 1;
    document.getElementById('miniQuizBox').style.pointerEvents = 'auto';
    document.getElementById('miniQuestion').textContent = `Traduire : "${wordObj.english}"`;
    document.getElementById('miniAnswer').value = '';
    document.getElementById('miniResult').textContent = '';
}

document.getElementById('miniCheck').addEventListener('click', ()=>{
    const currentWord = currentWords[currentIndex];
    if (currentWord.source === 'Manual Search') { return; } 
    const ans = sanitize(document.getElementById('miniAnswer').value).toLowerCase();
    const correct = (currentWord?.french || '').toLowerCase();
    const resEl = document.getElementById('miniResult');
    if(!ans){ resEl.textContent = '√âcris une r√©ponse pour valider.'; return; }
    if(ans === correct){ resEl.textContent = '‚úÖ Correct ! Bien jou√©.'; }
    else { resEl.textContent = `‚ùå Faux ‚Äî r√©ponse : ${currentWords[currentIndex].french}`; }
});

document.getElementById('miniSkip').addEventListener('click', ()=>{
    // go to next word in currentWords
    currentIndex = (currentIndex + 1) % currentWords.length;
    renderMainWord(currentWords[currentIndex]);
    setMiniQuestion(currentWords[currentIndex]);
});

/* ------------------ Chart rendering ------------------ */
function renderCharts(){
    // prepare last 7 days array
    const last7 = [...Array(7)].map((_,i)=>{
        const d = new Date(); d.setDate(d.getDate() - (6 - i));
        const s = d.toLocaleDateString();
        // Count words that are not manual searches
        return progress.daily.find(x=>x.date===s)?.words?.filter(w => w.source !== 'Manual Search').length || 0;
    });
    // cumulative
    const cumul = last7.reduce((arr,val,idx)=>{
        if(idx===0) return [val];
        arr.push(arr[idx-1]+val);
        return arr;
    },[]);

    // destroy old charts
    if(chartBar) chartBar.destroy();
    if(chartLine) chartLine.destroy();

    const ctxBar = document.getElementById('barChart').getContext('2d');
    chartBar = new Chart(ctxBar, {
        type:'bar',
        data:{
            labels: (()=>{const a=[]; for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i); a.push(d.toLocaleDateString());} return a;})(),
            datasets:[{label:'Mots appris', data:last7, backgroundColor: 'rgba(108,92,231,0.85)', borderRadius:6}]
        },
        options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });

    const ctxLine = document.getElementById('lineChart').getContext('2d');
    chartLine = new Chart(ctxLine, {
        type:'line',
        data:{
            labels: chartBar.data.labels,
            datasets:[{
                label:'Cumul',
                data:cumul,
                fill:true,
                borderColor:'#00c2b8',
                tension:0.35,
                backgroundColor:'rgba(0,194,184,0.12)',
                pointRadius:4
            }]
        },
        options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
}

/* ------------------ Flow: generate / display words ------------------ */
async function generateTodayWords(count){
    document.getElementById('apiStatus').textContent = 'R√©cup√©ration...';
    
    // Ensure the word list is loaded before generation starts
    if (allEnglishWords.length === 0) {
        await loadEnglishWordsList();
    }

    const arr = [];
    for(let i=0;i<count;i++){
        const obj = await fetchWordData(); // picks random unused word from local list
        arr.push(obj);
    }
    
    // store today's set (replace if already exists)
    const today = new Date().toLocaleDateString();
    // remove existing today's entry
    progress.daily = progress.daily.filter(d=>d.date!==today);
    progress.daily.push({ date: today, words: arr });
    saveProgress();

    currentWords = arr;
    currentIndex = 0;
    renderMainWord(currentWords[0]);
    renderWordsGrid(currentWords);
    setMiniQuestion(currentWords[0]);
    document.getElementById('apiStatus').textContent = 'Pr√™t';
    renderCharts();
}

/* ------------------ Manual Search Handler ------------------ */
document.getElementById('searchWordBtn').addEventListener('click', async () => {
    const searchWord = document.getElementById('searchWordInput').value;
    if (!searchWord) {
        log('Veuillez entrer un mot √† chercher.');
        return;
    }
    document.getElementById('apiStatus').textContent = `Recherche de "${searchWord}"...`;
    
    // fetch details using the unified function
    const wordDetails = await getWordDetails(searchWord, 'Manual Search');
    
    if (wordDetails) {
        // Temporarily replace currentWords array with the searched word for display/pronunciation
        currentWords = [wordDetails];
        currentIndex = 0;
        renderMainWord(wordDetails);
        document.getElementById('apiStatus').textContent = `Mot "${searchWord}" trouv√©.`;
    } else {
        // Fallback for not found
        renderMainWord({
            english: searchWord,
            french: 'Mot Inconnu',
            definition: 'D√©sol√©, ce mot n\'a pas pu √™tre trouv√© dans le dictionnaire API.',
            pos: '‚Äî',
            example: 'V√©rifiez l\'orthographe et r√©essayez.',
            image: `https://source.unsplash.com/featured/400x400/?not+found`,
            source: 'Manual Search'
        });
        document.getElementById('apiStatus').textContent = `Mot "${searchWord}" non trouv√©.`;
    }
});


function updateSideStats(){
    // Only count words that are not 'Manual Search' for statistics
    const total = progress.daily.reduce((s,d)=>s + (d.words?.filter(w => w.source !== 'Manual Search').length || 0), 0);
    document.getElementById('totalLearned').textContent = total;
    const today = new Date().toLocaleDateString();
    const todayCount = progress.daily.find(d=>d.date===today)?.words?.filter(w => w.source !== 'Manual Search').length || 0;
    document.getElementById('todayCount').textContent = todayCount;
    document.getElementById('favCount').textContent = progress.favorites.length;
    document.getElementById('todayDate').textContent = today;
}

/* ------------------ Buttons / Events ------------------ */
document.getElementById('startBtn').addEventListener('click', async ()=>{
    const cnt = parseInt(document.getElementById('wordsPerDay').value || '5');
    progress.settings.wordsPerDay = cnt;
    saveProgress();
    await generateTodayWords(cnt);
});

document.getElementById('nextBtn').addEventListener('click', async ()=>{
    if(confirm('Changer les mots d\'aujourd\'hui ?')) {
        const cnt = parseInt(document.getElementById('wordsPerDay').value || '5');
        await generateTodayWords(cnt);
    }
});

// favorite star main
document.getElementById('favoriteBtn').addEventListener('click', ()=>{
    const obj = currentWords[currentIndex];
    toggleFavorite(obj);
    updateFavList();
});

// copy
document.getElementById('copyBtn').addEventListener('click', ()=>{
    const text = currentWords[currentIndex]?.english || '';
    navigator.clipboard?.writeText(text).then(()=>{ log(`"${text}" copi√© dans le presse-papiers`); }).catch(()=>{ log('Impossible de copier'); });
});

// play main
document.getElementById('speakBtn').addEventListener('click', ()=>{
    const text = currentWords[currentIndex]?.english || '';
    speak(text,1.0);
});

// speak speed modes
document.getElementById('speakSlow').addEventListener('click', ()=>speak(currentWords[currentIndex]?.english || '',0.8));
document.getElementById('speakNormal').addEventListener('click', ()=>speak(currentWords[currentIndex]?.english || '',1.0));
document.getElementById('speakFast').addEventListener('click', ()=>speak(currentWords[currentIndex]?.english || '',1.4));

// wordsGrid click: handled when rendering (play / fav)
document.getElementById('clearFavs').addEventListener('click', ()=>{
    if(confirm('Supprimer tous les favoris ?')){ progress.favorites=[]; saveProgress(); updateFavList(); renderCharts(); }
});

// mini quiz navigation with main word click to advance through currentWords
document.getElementById('wordArea').addEventListener('click', (e)=>{
    // click on main area -> advance (only if not in search mode)
    if(e.target.closest('.icon-btn')) return;
    if(currentWords.length>0 && currentWords[0].source !== 'Manual Search'){
        currentIndex = (currentIndex + 1) % currentWords.length;
        renderMainWord(currentWords[currentIndex]);
        setMiniQuestion(currentWords[currentIndex]);
    }
});

/* ------------------ Init: load today's words if present else generate ------------------ */
async function loadTodayIfAny(){
    // 1. Load the master word list first
    await loadEnglishWordsList(); 

    // 2. Load daily words or generate new ones
    const today = new Date().toLocaleDateString();
    const day = progress.daily.find(d=>d.date===today);
    
    if(day && Array.isArray(day.words) && day.words.length>0){
        // Filter out any previous manual searches from the 'currentWords' array
        currentWords = day.words.filter(w => w.source !== 'Manual Search'); 
        if(currentWords.length === 0) {
             const cnt = parseInt(document.getElementById('wordsPerDay').value || '5');
             generateTodayWords(cnt);
             return;
        }

        currentIndex = 0;
        renderMainWord(currentWords[0]);
        renderWordsGrid(currentWords);
        setMiniQuestion(currentWords[0]);
    } else {
        // generate default with selected count
        const cnt = parseInt(document.getElementById('wordsPerDay').value || '5');
        generateTodayWords(cnt);
    }
    updateFavList();
    updateSideStats();
    renderCharts();
}

/* ------------------ voice populate and event when voices loaded ------------------ */
if (typeof speechSynthesis !== 'undefined') {
    populateVoice();
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoice;
    }
}

/* ------------------ Start ------------------ */
loadTodayIfAny();
log('Application initialis√©e. Bonne session !');

</script>
</body>

</html>
